# Copyright 2025 Splunk, Inc.
#
# Use of this source code is governed by a BSD-2-clause-style
# license that can be found in the LICENSE-BSD2 file or at
# https://opensource.org/licenses/BSD-2-Clause

from jinja2 import Environment, select_autoescape
import datetime
import pytest

from .sendmessage import sendsingle
from .splunkutils import  splunk_single


env = Environment(autoescape=select_autoescape(default_for_string=False))

#<135>Jul  4 10:20:33 hostname suricata[5885]: {"timestamp": "2025-07-04T10:20:33.093102+0000", "event_type": "stats", "stats": {"uptime": 856629, "capture": {"kernel_packets": 6669028, "kernel_drops": 11830, "errors": 0, "afpacket": {"busy_loop_avg": 1, "polls": 19963213, "poll_signal": 0, "poll_timeout": 16578677, "poll_data": 3384536, "poll_errors": 0, "send_errors": 0}}, "decoder": {"pkts": 6657198, "bytes": 4395115866, "invalid": 0, "ipv4": 6593307, "ipv6": 251, "ethernet": 6657198, "arp": 63640, "unknown_ethertype": 0, "chdlc": 0, "raw": 0, "null": 0, "sll": 0, "tcp": 6315117, "udp": 278190, "sctp": 0, "esp": 0, "icmpv4": 0, "icmpv6": 251, "ppp": 0, "pppoe": 0, "geneve": 0, "gre": 0, "vlan": 0, "vlan_qinq": 0, "vlan_qinqinq": 0, "vxlan": 0, "vntag": 0, "ieee8021ah": 0, "teredo": 0, "ipv4_in_ipv6": 0, "ipv6_in_ipv6": 0, "mpls": 0, "avg_pkt_size": 660, "max_pkt_size": 9015, "max_mac_addrs_src": 0, "max_mac_addrs_dst": 0, "erspan": 0, "nsh": 0, "event": {"afpacket": {"trunc_pkt": 0}, "ipv4": {"pkt_too_small": 0, "hlen_too_small": 0, "iplen_smaller_than_hlen": 0, "trunc_pkt": 0, "opt_invalid": 0, "opt_invalid_len": 0, "opt_malformed": 0, "opt_pad_required": 0, "opt_eol_required": 0, "opt_duplicate": 0, "opt_unknown": 0, "wrong_ip_version": 0, "icmpv6": 0, "frag_pkt_too_large": 0, "frag_overlap": 0, "frag_ignored": 0}, "icmpv4": {"pkt_too_small": 0, "unknown_type": 0, "unknown_code": 0, "ipv4_trunc_pkt": 0, "ipv4_unknown_ver": 0}, "icmpv6": {"unknown_type": 0, "unknown_code": 0, "pkt_too_small": 0, "ipv6_unknown_version": 0, "ipv6_trunc_pkt": 0, "mld_message_with_invalid_hl": 0, "unassigned_type": 0, "experimentation_type": 0}, "ipv6": {"pkt_too_small": 0, "trunc_pkt": 0, "trunc_exthdr": 0, "exthdr_dupl_fh": 0, "exthdr_useless_fh": 0, "exthdr_dupl_rh": 0, "exthdr_dupl_hh": 0, "exthdr_dupl_dh": 0, "exthdr_dupl_ah": 0, "exthdr_dupl_eh": 0, "exthdr_invalid_optlen": 0, "wrong_ip_version": 0, "exthdr_ah_res_not_null": 0, "hopopts_unknown_opt": 0, "hopopts_only_padding": 0, "dstopts_unknown_opt": 0, "dstopts_only_padding": 0, "rh_type_0": 0, "zero_len_padn": 2, "fh_non_zero_reserved_field": 0, "data_after_none_header": 0, "unknown_next_header": 0, "icmpv4": 0, "frag_pkt_too_large": 0, "frag_overlap": 0, "frag_invalid_length": 0, "frag_ignored": 0, "ipv4_in_ipv6_too_small": 0, "ipv4_in_ipv6_wrong_version": 0, "ipv6_in_ipv6_too_small": 0, "ipv6_in_ipv6_wrong_version": 0}, "tcp": {"pkt_too_small": 0, "hlen_too_small": 0, "invalid_optlen": 0, "opt_invalid_len": 0, "opt_duplicate": 0}, "udp": {"pkt_too_small": 0, "hlen_too_small": 0, "hlen_invalid": 0, "len_invalid": 0}, "sll": {"pkt_too_small": 0}, "ethernet": {"pkt_too_small": 0}, "ppp": {"pkt_too_small": 0, "vju_pkt_too_small": 0, "ip4_pkt_too_small": 0, "ip6_pkt_too_small": 0, "wrong_type": 0, "unsup_proto": 0}, "pppoe": {"pkt_too_small": 0, "wrong_code": 0, "malformed_tags": 0}, "gre": {"pkt_too_small": 0, "wrong_version": 0, "version0_recur": 0, "version0_flags": 0, "version0_hdr_too_big": 0, "version0_malformed_sre_hdr": 0, "version1_chksum": 0, "version1_route": 0, "version1_ssr": 0, "version1_recur": 0, "version1_flags": 0, "version1_no_key": 0, "version1_wrong_protocol": 0, "version1_malformed_sre_hdr": 0, "version1_hdr_too_big": 0}, "vlan": {"header_too_small": 0, "unknown_type": 0, "too_many_layers": 0}, "ieee8021ah": {"header_too_small": 0}, "vntag": {"header_too_small": 0, "unknown_type": 0}, "ipraw": {"invalid_ip_version": 0}, "ltnull": {"pkt_too_small": 0, "unsupported_type": 0}, "sctp": {"pkt_too_small": 0}, "esp": {"pkt_too_small": 0}, "mpls": {"header_too_small": 0, "pkt_too_small": 0, "bad_label_router_alert": 0, "bad_label_implicit_null": 0, "bad_label_reserved": 0, "unknown_payload_type": 0}, "vxlan": {"unknown_payload_type": 0}, "geneve": {"unknown_payload_type": 0}, "erspan": {"header_too_small": 0, "unsupported_version": 0, "too_many_vlan_layers": 0}, "dce": {"pkt_too_small": 0}, "chdlc": {"pkt_too_small": 0}, "nsh": {"header_too_small": 0, "unsupported_version": 0, "bad_header_length": 0, "reserved_type": 0, "unsupported_type": 0, "unknown_payload": 0}}, "too_many_layers": 0}, "tcp": {"syn": 282270, "synack": 282198, "rst": 229397, "urg": 0, "active_sessions": 24, "sessions": 282201, "ssn_memcap_drop": 0, "ssn_from_cache": 61623, "ssn_from_pool": 220578, "pseudo": 0, "pseudo_failed": 0, "invalid_checksum": 0, "midstream_pickups": 0, "pkt_on_wrong_thread": 0, "ack_unseen_data": 124, "segment_memcap_drop": 0, "segment_from_cache": 635029, "segment_from_pool": 557760, "stream_depth_reached": 86, "reassembly_gap": 0, "overlap": 1238, "overlap_diff_data": 0, "insert_data_normal_fail": 0, "insert_data_overlap_fail": 0, "urgent_oob_data": 0, "memuse": 1245184, "reassembly_memuse": 497944}, "flow": {"memcap": 0, "total": 412294, "active": 73, "tcp": 287310, "udp": 124737, "icmpv4": 0, "icmpv6": 247, "tcp_reuse": 305, "get_used": 0, "get_used_eval": 0, "get_used_eval_reject": 0, "get_used_eval_busy": 0, "get_used_failed": 0, "wrk": {"spare_sync_avg": 99, "spare_sync": 3520, "spare_sync_incomplete": 1161, "spare_sync_empty": 0, "flows_evicted_needs_work": 61313, "flows_evicted_pkt_inject": 97829, "flows_evicted": 2412, "flows_injected": 61269, "flows_injected_max": 3}, "end": {"state": {"new": 5430, "established": 124618, "closed": 282173, "local_bypassed": 0, "capture_bypassed": 0}, "tcp_state": {"none": 0, "syn_sent": 3, "syn_recv": 0, "established": 1, "fin_wait1": 0, "fin_wait2": 0, "time_wait": 1, "last_ack": 0, "close_wait": 0, "closing": 0, "closed": 282172}, "tcp_liberal": 0}, "mgr": {"full_hash_pass": 86016, "rows_per_sec": 6553, "rows_maxlen": 2, "flows_checked": 911524, "flows_notimeout": 500274, "flows_timeout": 411250, "flows_evicted": 411263, "flows_evicted_needs_work": 61269}, "spare": 9794, "emerg_mode_entered": 0, "emerg_mode_over": 0, "recycler": {"recycled": 349994, "queue_avg": 0, "queue_max": 15}, "memuse": 7154304}, "defrag": {"ipv4": {"fragments": 0, "reassembled": 0}, "ipv6": {"fragments": 0, "reassembled": 0}, "max_frag_hits": 0}, "flow_bypassed": {"local_pkts": 0, "local_bytes": 0, "local_capture_pkts": 0, "local_capture_bytes": 0, "closed": 0, "pkts": 0, "bytes": 0}, "detect": {"engines": [{"id": 0, "last_reload": "2025-06-24T12:23:53.703217+0000", "rules_loaded": 44240, "rules_failed": 0, "rules_skipped": 0}], "alert": 1331, "alert_queue_overflow": 0, "alerts_suppressed": 260552}, "app_layer": {"flow": {"http": 257299, "ftp": 0, "smtp": 0, "tls": 24877, "ssh": 0, "imap": 0, "smb": 0, "dcerpc_tcp": 0, "dns_tcp": 0, "nfs_tcp": 17, "ntp": 60657, "ftp-data": 0, "tftp": 0, "ike": 0, "krb5_tcp": 0, "quic": 0, "dhcp": 477, "snmp": 0, "sip": 0, "rfb": 0, "mqtt": 0, "telnet": 0, "rdp": 0, "http2": 0, "bittorrent-dht": 0, "failed_tcp": 4, "dcerpc_udp": 0, "dns_udp": 63603, "nfs_udp": 0, "krb5_udp": 0, "failed_udp": 0}, "tx": {"http": 257435, "ftp": 0, "smtp": 0, "tls": 0, "ssh": 0, "imap": 0, "smb": 0, "dcerpc_tcp": 0, "dns_tcp": 0, "nfs_tcp": 0, "ntp": 60690, "ftp-data": 0, "tftp": 0, "ike": 0, "krb5_tcp": 0, "quic": 0, "dhcp": 956, "snmp": 0, "sip": 0, "rfb": 0, "mqtt": 0, "telnet": 0, "rdp": 0, "http2": 0, "bittorrent-dht": 0, "dcerpc_udp": 0, "dns_udp": 155894, "nfs_udp": 0, "krb5_udp": 0}, "error": {"http": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "ftp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "smtp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "tls": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "ssh": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "imap": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "smb": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "dcerpc_tcp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "dns_tcp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "nfs_tcp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "ntp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "ftp-data": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "tftp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "ike": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "krb5_tcp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "quic": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "dhcp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "snmp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "sip": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "rfb": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "mqtt": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "telnet": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "rdp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "http2": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "bittorrent-dht": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "failed_tcp": {"gap": 0}, "dcerpc_udp": {"alloc": 0, "parser": 0, "internal": 0}, "dns_udp": {"alloc": 0, "parser": 0, "internal": 0}, "nfs_udp": {"alloc": 0, "parser": 0, "internal": 0}, "krb5_udp": {"alloc": 0, "parser": 0, "internal": 0}}, "expectations": 0}, "memcap_pressure": 5, "memcap_pressure_max": 5, "http": {"memuse": 27478, "memcap": 0}, "ftp": {"memuse": 0, "memcap": 0}, "file_store": {"open_files": 0}}}
#<135>Jul  4 10:20:34 hostname suricata[5885]: {"timestamp":"2025-07-04T10:20:34.876151+0000","flow_id":254581151187804,"in_iface":"ens5","event_type":"flow","src_ip":"10.202.11.111","src_port":33008,"dest_ip":"169.254.169.254","dest_port":80,"proto":"TCP","app_proto":"http","flow":{"pkts_toserver":5,"pkts_toclient":5,"bytes_toserver":572,"bytes_toclient":864,"start":"2025-07-04T10:19:28.124810+0000","end":"2025-07-04T10:19:28.125685+0000","age":0,"state":"closed","reason":"timeout","alerted":false},"metadata":{"flowbits":["http.dottedquadhost"]},"tcp":{"tcp_flags":"1b","tcp_flags_ts":"1b","tcp_flags_tc":"1b","syn":true,"fin":true,"psh":true,"ack":true,"state":"closed","ts_max_regions":1,"tc_max_regions":1}}
#<135>Jul  4 10:21:02 hostname suricata[5885]: {"timestamp":"2025-07-04T10:21:02.629670+0000","flow_id":1859988758741639,"in_iface":"ens5","event_type":"dns","src_ip":"10.202.11.111","src_port":60883,"dest_ip":"10.136.2.4","dest_port":53,"proto":"UDP","pkt_src":"wire/pcap","dns":{"version":2,"type":"query","id":54196,"rrname":"monitoring.us-west-2.amazonaws.com","rrtype":"AAAA","tx_id":0,"opcode":0}}
#<135>Jul  4 10:20:49 hostname suricata[5885]: {"timestamp":"2025-07-04T10:20:49.851353+0000","flow_id":555560714550336,"in_iface":"ens5","event_type":"fileinfo","src_ip":"169.254.169.254","src_port":80,"dest_ip":"10.202.11.111","dest_port":34950,"proto":"TCP","pkt_src":"stream (flow timeout)","metadata":{"flowbits":["http.dottedquadhost"]},"http":{"hostname":"169.254.169.254","http_port":80,"url":"/latest/api/token","http_user_agent":"NessusAgent/10.9.0","http_content_type":"text/plain","http_method":"PUT","protocol":"HTTP/1.1","status":200,"length":56},"app_proto":"http","fileinfo":{"filename":"/latest/api/token","gaps":false,"state":"CLOSED","stored":false,"size":56,"tx_id":0}}
#<135>Jul  4 10:21:45 hostname suricata[5885]: {"timestamp":"2025-07-04T10:21:45.706185+0000","flow_id":492213234342652,"in_iface":"ens5","event_type":"http","src_ip":"10.202.11.111","src_port":48656,"dest_ip":"169.254.169.254","dest_port":80,"proto":"TCP","pkt_src":"wire/pcap","metadata":{"flowbits":["http.dottedquadhost"]},"tx_id":0,"http":{"hostname":"169.254.169.254","http_port":80,"url":"/latest/api/token","http_user_agent":"NessusAgent/10.9.0","http_content_type":"text/plain","http_method":"PUT","protocol":"HTTP/1.1","status":200,"length":56}}
#<135>Jul  4 10:21:02 hostname suricata[5885]: {"timestamp":"2025-07-04T10:21:02.706953+0000","flow_id":1885807310450707,"in_iface":"ens5","event_type":"tls","src_ip":"10.202.11.111","src_port":53668,"dest_ip":"35.92.124.238","dest_port":443,"proto":"TCP","pkt_src":"wire/pcap","tls":{"sni":"monitoring.us-west-2.amazonaws.com","version":"TLS 1.3","ja3":{"hash":"6d5f35fb7243459b41a74ad9f23d7393","string":"771,49195-49199-49196-49200-52393-52392-49161-49171-49162-49172-4865-4866-4867,0-11-65281-23-18-5-10-13-16-43-51,29-23-24-25,0"},"ja3s":{"hash":"f4febc55ea12b31ae17cfb7e614afda8","string":"771,4865,43-51"}}}

test_data = [
    {
        "event": '{{ mark }} {{ timestamp_bsd }} {{ host }} suricata[5885]: {"timestamp": "{{  timestamp_iso_8601 }}", "event_type": "stats", "stats": {"uptime": 856629, "capture": {"kernel_packets": 6669028, "kernel_drops": 11830, "errors": 0, "afpacket": {"busy_loop_avg": 1, "polls": 19963213, "poll_signal": 0, "poll_timeout": 16578677, "poll_data": 3384536, "poll_errors": 0, "send_errors": 0}}, "decoder": {"pkts": 6657198, "bytes": 4395115866, "invalid": 0, "ipv4": 6593307, "ipv6": 251, "ethernet": 6657198, "arp": 63640, "unknown_ethertype": 0, "chdlc": 0, "raw": 0, "null": 0, "sll": 0, "tcp": 6315117, "udp": 278190, "sctp": 0, "esp": 0, "icmpv4": 0, "icmpv6": 251, "ppp": 0, "pppoe": 0, "geneve": 0, "gre": 0, "vlan": 0, "vlan_qinq": 0, "vlan_qinqinq": 0, "vxlan": 0, "vntag": 0, "ieee8021ah": 0, "teredo": 0, "ipv4_in_ipv6": 0, "ipv6_in_ipv6": 0, "mpls": 0, "avg_pkt_size": 660, "max_pkt_size": 9015, "max_mac_addrs_src": 0, "max_mac_addrs_dst": 0, "erspan": 0, "nsh": 0, "event": {"afpacket": {"trunc_pkt": 0}, "ipv4": {"pkt_too_small": 0, "hlen_too_small": 0, "iplen_smaller_than_hlen": 0, "trunc_pkt": 0, "opt_invalid": 0, "opt_invalid_len": 0, "opt_malformed": 0, "opt_pad_required": 0, "opt_eol_required": 0, "opt_duplicate": 0, "opt_unknown": 0, "wrong_ip_version": 0, "icmpv6": 0, "frag_pkt_too_large": 0, "frag_overlap": 0, "frag_ignored": 0}, "icmpv4": {"pkt_too_small": 0, "unknown_type": 0, "unknown_code": 0, "ipv4_trunc_pkt": 0, "ipv4_unknown_ver": 0}, "icmpv6": {"unknown_type": 0, "unknown_code": 0, "pkt_too_small": 0, "ipv6_unknown_version": 0, "ipv6_trunc_pkt": 0, "mld_message_with_invalid_hl": 0, "unassigned_type": 0, "experimentation_type": 0}, "ipv6": {"pkt_too_small": 0, "trunc_pkt": 0, "trunc_exthdr": 0, "exthdr_dupl_fh": 0, "exthdr_useless_fh": 0, "exthdr_dupl_rh": 0, "exthdr_dupl_hh": 0, "exthdr_dupl_dh": 0, "exthdr_dupl_ah": 0, "exthdr_dupl_eh": 0, "exthdr_invalid_optlen": 0, "wrong_ip_version": 0, "exthdr_ah_res_not_null": 0, "hopopts_unknown_opt": 0, "hopopts_only_padding": 0, "dstopts_unknown_opt": 0, "dstopts_only_padding": 0, "rh_type_0": 0, "zero_len_padn": 2, "fh_non_zero_reserved_field": 0, "data_after_none_header": 0, "unknown_next_header": 0, "icmpv4": 0, "frag_pkt_too_large": 0, "frag_overlap": 0, "frag_invalid_length": 0, "frag_ignored": 0, "ipv4_in_ipv6_too_small": 0, "ipv4_in_ipv6_wrong_version": 0, "ipv6_in_ipv6_too_small": 0, "ipv6_in_ipv6_wrong_version": 0}, "tcp": {"pkt_too_small": 0, "hlen_too_small": 0, "invalid_optlen": 0, "opt_invalid_len": 0, "opt_duplicate": 0}, "udp": {"pkt_too_small": 0, "hlen_too_small": 0, "hlen_invalid": 0, "len_invalid": 0}, "sll": {"pkt_too_small": 0}, "ethernet": {"pkt_too_small": 0}, "ppp": {"pkt_too_small": 0, "vju_pkt_too_small": 0, "ip4_pkt_too_small": 0, "ip6_pkt_too_small": 0, "wrong_type": 0, "unsup_proto": 0}, "pppoe": {"pkt_too_small": 0, "wrong_code": 0, "malformed_tags": 0}, "gre": {"pkt_too_small": 0, "wrong_version": 0, "version0_recur": 0, "version0_flags": 0, "version0_hdr_too_big": 0, "version0_malformed_sre_hdr": 0, "version1_chksum": 0, "version1_route": 0, "version1_ssr": 0, "version1_recur": 0, "version1_flags": 0, "version1_no_key": 0, "version1_wrong_protocol": 0, "version1_malformed_sre_hdr": 0, "version1_hdr_too_big": 0}, "vlan": {"header_too_small": 0, "unknown_type": 0, "too_many_layers": 0}, "ieee8021ah": {"header_too_small": 0}, "vntag": {"header_too_small": 0, "unknown_type": 0}, "ipraw": {"invalid_ip_version": 0}, "ltnull": {"pkt_too_small": 0, "unsupported_type": 0}, "sctp": {"pkt_too_small": 0}, "esp": {"pkt_too_small": 0}, "mpls": {"header_too_small": 0, "pkt_too_small": 0, "bad_label_router_alert": 0, "bad_label_implicit_null": 0, "bad_label_reserved": 0, "unknown_payload_type": 0}, "vxlan": {"unknown_payload_type": 0}, "geneve": {"unknown_payload_type": 0}, "erspan": {"header_too_small": 0, "unsupported_version": 0, "too_many_vlan_layers": 0}, "dce": {"pkt_too_small": 0}, "chdlc": {"pkt_too_small": 0}, "nsh": {"header_too_small": 0, "unsupported_version": 0, "bad_header_length": 0, "reserved_type": 0, "unsupported_type": 0, "unknown_payload": 0}}, "too_many_layers": 0}, "tcp": {"syn": 282270, "synack": 282198, "rst": 229397, "urg": 0, "active_sessions": 24, "sessions": 282201, "ssn_memcap_drop": 0, "ssn_from_cache": 61623, "ssn_from_pool": 220578, "pseudo": 0, "pseudo_failed": 0, "invalid_checksum": 0, "midstream_pickups": 0, "pkt_on_wrong_thread": 0, "ack_unseen_data": 124, "segment_memcap_drop": 0, "segment_from_cache": 635029, "segment_from_pool": 557760, "stream_depth_reached": 86, "reassembly_gap": 0, "overlap": 1238, "overlap_diff_data": 0, "insert_data_normal_fail": 0, "insert_data_overlap_fail": 0, "urgent_oob_data": 0, "memuse": 1245184, "reassembly_memuse": 497944}, "flow": {"memcap": 0, "total": 412294, "active": 73, "tcp": 287310, "udp": 124737, "icmpv4": 0, "icmpv6": 247, "tcp_reuse": 305, "get_used": 0, "get_used_eval": 0, "get_used_eval_reject": 0, "get_used_eval_busy": 0, "get_used_failed": 0, "wrk": {"spare_sync_avg": 99, "spare_sync": 3520, "spare_sync_incomplete": 1161, "spare_sync_empty": 0, "flows_evicted_needs_work": 61313, "flows_evicted_pkt_inject": 97829, "flows_evicted": 2412, "flows_injected": 61269, "flows_injected_max": 3}, "end": {"state": {"new": 5430, "established": 124618, "closed": 282173, "local_bypassed": 0, "capture_bypassed": 0}, "tcp_state": {"none": 0, "syn_sent": 3, "syn_recv": 0, "established": 1, "fin_wait1": 0, "fin_wait2": 0, "time_wait": 1, "last_ack": 0, "close_wait": 0, "closing": 0, "closed": 282172}, "tcp_liberal": 0}, "mgr": {"full_hash_pass": 86016, "rows_per_sec": 6553, "rows_maxlen": 2, "flows_checked": 911524, "flows_notimeout": 500274, "flows_timeout": 411250, "flows_evicted": 411263, "flows_evicted_needs_work": 61269}, "spare": 9794, "emerg_mode_entered": 0, "emerg_mode_over": 0, "recycler": {"recycled": 349994, "queue_avg": 0, "queue_max": 15}, "memuse": 7154304}, "defrag": {"ipv4": {"fragments": 0, "reassembled": 0}, "ipv6": {"fragments": 0, "reassembled": 0}, "max_frag_hits": 0}, "flow_bypassed": {"local_pkts": 0, "local_bytes": 0, "local_capture_pkts": 0, "local_capture_bytes": 0, "closed": 0, "pkts": 0, "bytes": 0}, "detect": {"engines": [{"id": 0, "last_reload": "2025-06-24T12:23:53.703217+0000", "rules_loaded": 44240, "rules_failed": 0, "rules_skipped": 0}], "alert": 1331, "alert_queue_overflow": 0, "alerts_suppressed": 260552}, "app_layer": {"flow": {"http": 257299, "ftp": 0, "smtp": 0, "tls": 24877, "ssh": 0, "imap": 0, "smb": 0, "dcerpc_tcp": 0, "dns_tcp": 0, "nfs_tcp": 17, "ntp": 60657, "ftp-data": 0, "tftp": 0, "ike": 0, "krb5_tcp": 0, "quic": 0, "dhcp": 477, "snmp": 0, "sip": 0, "rfb": 0, "mqtt": 0, "telnet": 0, "rdp": 0, "http2": 0, "bittorrent-dht": 0, "failed_tcp": 4, "dcerpc_udp": 0, "dns_udp": 63603, "nfs_udp": 0, "krb5_udp": 0, "failed_udp": 0}, "tx": {"http": 257435, "ftp": 0, "smtp": 0, "tls": 0, "ssh": 0, "imap": 0, "smb": 0, "dcerpc_tcp": 0, "dns_tcp": 0, "nfs_tcp": 0, "ntp": 60690, "ftp-data": 0, "tftp": 0, "ike": 0, "krb5_tcp": 0, "quic": 0, "dhcp": 956, "snmp": 0, "sip": 0, "rfb": 0, "mqtt": 0, "telnet": 0, "rdp": 0, "http2": 0, "bittorrent-dht": 0, "dcerpc_udp": 0, "dns_udp": 155894, "nfs_udp": 0, "krb5_udp": 0}, "error": {"http": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "ftp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "smtp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "tls": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "ssh": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "imap": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "smb": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "dcerpc_tcp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "dns_tcp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "nfs_tcp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "ntp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "ftp-data": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "tftp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "ike": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "krb5_tcp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "quic": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "dhcp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "snmp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "sip": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "rfb": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "mqtt": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "telnet": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "rdp": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "http2": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "bittorrent-dht": {"gap": 0, "alloc": 0, "parser": 0, "internal": 0}, "failed_tcp": {"gap": 0}, "dcerpc_udp": {"alloc": 0, "parser": 0, "internal": 0}, "dns_udp": {"alloc": 0, "parser": 0, "internal": 0}, "nfs_udp": {"alloc": 0, "parser": 0, "internal": 0}, "krb5_udp": {"alloc": 0, "parser": 0, "internal": 0}}, "expectations": 0}, "memcap_pressure": 5, "memcap_pressure_max": 5, "http": {"memuse": 27478, "memcap": 0}, "ftp": {"memuse": 0, "memcap": 0}, "file_store": {"open_files": 0}}}',
        "sourcetype": "suricata:stats",
    },
    {
        "event": '{{ mark }} {{ timestamp_bsd }} {{ host }} suricata[5885]: {"timestamp":"{{  timestamp_iso_8601 }}","flow_id":254581151187804,"in_iface":"ens5","event_type":"flow","src_ip":"10.202.11.111","src_port":33008,"dest_ip":"169.254.169.254","dest_port":80,"proto":"TCP","app_proto":"http","flow":{"pkts_toserver":5,"pkts_toclient":5,"bytes_toserver":572,"bytes_toclient":864,"start":"2025-07-04T10:19:28.124810+0000","end":"2025-07-04T10:19:28.125685+0000","age":0,"state":"closed","reason":"timeout","alerted":false},"metadata":{"flowbits":["http.dottedquadhost"]},"tcp":{"tcp_flags":"1b","tcp_flags_ts":"1b","tcp_flags_tc":"1b","syn":true,"fin":true,"psh":true,"ack":true,"state":"closed","ts_max_regions":1,"tc_max_regions":1}}',
        "sourcetype": "suricata:flow",
    },
    {
        "event": '{{ mark }} {{ timestamp_bsd }} {{ host }} suricata[5885]: {"timestamp":"{{  timestamp_iso_8601 }}","flow_id":1859988758741639,"in_iface":"ens5","event_type":"dns","src_ip":"10.202.11.111","src_port":60883,"dest_ip":"10.136.2.4","dest_port":53,"proto":"UDP","pkt_src":"wire/pcap","dns":{"version":2,"type":"query","id":54196,"rrname":"monitoring.us-west-2.amazonaws.com","rrtype":"AAAA","tx_id":0,"opcode":0}}',
        "sourcetype": "suricata:dns",
    },
    {
        "event": '{{ mark }} {{ timestamp_bsd }} {{ host }} suricata[5885]: {"timestamp":"{{  timestamp_iso_8601 }}","flow_id":555560714550336,"in_iface":"ens5","event_type":"fileinfo","src_ip":"169.254.169.254","src_port":80,"dest_ip":"10.202.11.111","dest_port":34950,"proto":"TCP","pkt_src":"stream (flow timeout)","metadata":{"flowbits":["http.dottedquadhost"]},"http":{"hostname":"169.254.169.254","http_port":80,"url":"/latest/api/token","http_user_agent":"NessusAgent/10.9.0","http_content_type":"text/plain","http_method":"PUT","protocol":"HTTP/1.1","status":200,"length":56},"app_proto":"http","fileinfo":{"filename":"/latest/api/token","gaps":false,"state":"CLOSED","stored":false,"size":56,"tx_id":0}}',
        "sourcetype": "suricata:fileinfo",
    },
    {
        "event": '{{ mark }} {{ timestamp_bsd }} {{ host }} suricata[5885]: {"timestamp":"{{  timestamp_iso_8601 }}","flow_id":492213234342652,"in_iface":"ens5","event_type":"http","src_ip":"10.202.11.111","src_port":48656,"dest_ip":"169.254.169.254","dest_port":80,"proto":"TCP","pkt_src":"wire/pcap","metadata":{"flowbits":["http.dottedquadhost"]},"tx_id":0,"http":{"hostname":"169.254.169.254","http_port":80,"url":"/latest/api/token","http_user_agent":"NessusAgent/10.9.0","http_content_type":"text/plain","http_method":"PUT","protocol":"HTTP/1.1","status":200,"length":56}}',
        "sourcetype": "suricata:http",
    },
    {
        "event": '{{ mark }} {{ timestamp_bsd }} {{ host }} suricata[5885]: {"timestamp":"{{  timestamp_iso_8601 }}","flow_id":1885807310450707,"in_iface":"ens5","event_type":"tls","src_ip":"10.202.11.111","src_port":53668,"dest_ip":"35.92.124.238","dest_port":443,"proto":"TCP","pkt_src":"wire/pcap","tls":{"sni":"monitoring.us-west-2.amazonaws.com","version":"TLS 1.3","ja3":{"hash":"6d5f35fb7243459b41a74ad9f23d7393","string":"771,49195-49199-49196-49200-52393-52392-49161-49171-49162-49172-4865-4866-4867,0-11-65281-23-18-5-10-13-16-43-51,29-23-24-25,0"},"ja3s":{"hash":"f4febc55ea12b31ae17cfb7e614afda8","string":"771,4865,43-51"}}}',
        "sourcetype": "suricata:tls",
    }
]

@pytest.mark.addons("suricata")
@pytest.mark.parametrize("sample", test_data)
def test_suricata(record_property, get_host_key, setup_splunk, setup_sc4s, sample):
    host = get_host_key

    dt = datetime.datetime.now(datetime.timezone.utc)
    timestamp_bsd = dt.strftime("%b %e %H:%M:%S")
    timestamp_iso_8601 = dt.isoformat()
    epoch = dt.astimezone().strftime("%s.%f")[:-3]
    
    mt = env.from_string(sample["event"])

    message = mt.render(mark="<135>", timestamp_bsd=timestamp_bsd, host=host, timestamp_iso_8601=timestamp_iso_8601)
    sendsingle(message, setup_sc4s[0], setup_sc4s[1][514])

    st = env.from_string(
        'search _time={{ epoch }} index=netids  host={{ host }} sourcetype="{{ sourcetype }}"'
    )
    search = st.render(
        epoch=epoch, host=host, sourcetype=sample["sourcetype"]
    )

    result_count, _ = splunk_single(setup_splunk, search)

    record_property("host", host)
    record_property("resultCount", result_count)
    record_property("message", message)

    assert result_count == 1
