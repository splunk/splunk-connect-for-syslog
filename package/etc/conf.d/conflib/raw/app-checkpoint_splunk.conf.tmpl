block parser checkpoint_splunk-parser() {    
 channel {
        
        parser {
            kv-parser(prefix(".cp.") pair-separator("|") template(t_hdr_msg));
            
        };

        if {
            filter { "${.cp.loguid}" ne "" };
            parser {
                grouping-by(
                    key("${.cp.loguid}")
                    #This looks silly but we have no way of knowing if an event is complete so 
                    #We must make an impossible condition and rely on time out
                    trigger("1" == "2")
                    aggregate(
                        value(".gb.complete" "1")
                        inherit-mode(last-message)
                    )
                    timeout({{- (print (getenv "SC4S_LISTEN_CHECKPOINT_SPLUNK_NOISE_CONTROL_SECONDS" "2")) }})
                );
            };
        } else {
            rewrite {            
                set("1", value(".gb.complete"));
            };
        };
        parser {
            date-parser-nofilter(format("%s") template("${.cp.time}"));
        };
    
        rewrite {            
            set("${.cp.hostname}", value("HOST"));
            set("${.cp.hostname}", value("fields.cp_lm"));

            set("checkpoint_splunk", value("fields.sc4s_syslog_format"));
            set("checkpoint_splunk", value("fields.sc4s_vendor_product"));    
            set("netfw", value(".splunk.index"));
            set("SC4S", value(".splunk.source"));
            set("cp_log", value(".splunk.sourcetype"));
            set("t_msg_only", value(".splunk.sc4s_template"));
                        
            #set-tag("noparse");
            #set-tag("checkpoint_splunk");      
        };                       
            

        if {
            #Get the FW host from the originsicname
            filter {                
                match('^[Cc][Nn]\\?=([^,]+)' value(".cp.originsicname") flags(store-matches));
            };
            rewrite {
                set("$1", value("HOST"));
            };
        } elif {
            #Get the FW host from the origin_sic_name
            filter {                
                match('^[Cc][Nn]\\?=([^,]+)' value(".cp.origin_sic_name") flags(store-matches));
            };
            rewrite {
                set("$1", value("HOST"));
            };
        };        
        # If this device is a v host we need to get the firewall name
        if {
            filter {                
                host('-v_(.*)' flags(store-matches));                
            };
            rewrite {
                set("$1", value("HOST"));
            };
        };      

        if {
            filter {
                "${.cp.product}" eq "Syslog"
            };
            parser {
                syslog-parser(
                    flags(assume-utf8, no-hostname, store-raw-message)
                    template("${.cp.default_device_message}")
                    );
            };     
            parser {
                date-parser-nofilter(format("%s") template("${.cp.time}"));
            };           
            rewrite { 
                set("checkpoint_splunk", value("fields.sc4s_vendor_product"));    
                set("netops", value(".splunk.index"));
                set("program:${PROGRAM}", value(".splunk.source"));
                set("nix:syslog", value(".splunk.sourcetype"));
                set("t_hdr_msg", value(".splunk.sc4s_template"));
            
            };             
        } elif {
            filter {
                match('Firewall' value('.cp.product'))
                or match('Application\h+Control' value('.cp.product'))
                or match('RAD' value('.cp.product'))
                or match('HTTPS\h+Inspection' value('.cp.product'))
                or match('Compliance\h+Blade' value('.cp.product'))
                or match('Compliance' value('.cp.product'))
                or match('VPN-1\h+&\h+Fire[wW]all-1' value('.cp.product'))
                or match('Network\h+Security' value('.cp.product'))
                and not match('VPN' value('.cp.fw_subproduct'))
            };
            rewrite { 
                set("checkpoint_splunk_firewall", value("fields.sc4s_vendor_product"));    
                set("netfw", value(".splunk.index"));
                set("cp_log:firewall", value(".splunk.source"));
            };
        } elif  {
            filter {
                match('U[rR][lL]\h+Filtering' value('.cp.product'))
            };
            rewrite { 
                set("checkpoint_splunk_web", value("fields.sc4s_vendor_product"));    
                set("netproxy", value(".splunk.index"));
                set("cp_log:web", value(".splunk.source"));
            };
        } elif  {
            filter {
                match('Scheduled\h+system\h+update' value('.cp.product'))
                or match('WEB_API' value('.cp.product'))
                or match('SmartDefense' value('.cp.product'))
                or match('Smart\h+Defense' value('.cp.product'))
                or match('W[eE][bB]-UI' value('.cp.product'))
                or match('SmartDashboard' value('.cp.product'))
                or match('System\h+Monitor' value('.cp.product'))
                or match('Log\h+Update' value('.cp.product'))
                or match('license-mgmt' value('.cp.product'))
                or match('smart_event' value('.cp.product'))
                or match('SmartConsole' value('.cp.product'))
                or match('SmartEvent\h+Client' value('.cp.product'))
                or match('SmartUpdate' value('.cp.product'))
                or match('SmartView' value('.cp.product'))
                or match('Security\h+Gateway\/Management' value('.cp.product'))
                or match('Smart\h+Defense' value('.cp.product'))
                or match('WEB_API_INTERNAL' value('.cp.product'))
                or match('Eventia\h+Analyzer\h+Client' value('.cp.product'))
                or match('SmartProvisioning\h+Connector' value('.cp.product'))
                or match('SmartLSM\h+Endpoint\h+Security\h+Console' value('.cp.product'))
                or match('SmartLSM' value('.cp.product'))
                or match('ROBO\h+GUI' value('.cp.product'))
                or match('Management\h+Blade' value('.cp.product'))
                or match('Connectra' value('.cp.product'))
                or match('Check\h+Point\h+Security\h+Management\h+Server' value('.cp.product'))
            };
            rewrite { 
                set("checkpoint_splunk_audit", value("fields.sc4s_vendor_product"));    
                set("netops", value(".splunk.index"));
                set("cp_log:audit", value(".splunk.source"));
            };
        } elif  {
            filter {
                match('Endpoint\h+Management' value('.cp.product'))
                or match('Core' value('.cp.product'))
                or match('Endpoint\h+Compliance' value('.cp.product'))
                or match('MEPP' value('.cp.product'))
                or match('Media\h+Encryption\h+&\h+Port\h+Protection' value('.cp.product'))
                or match('Endpoint\h+Security\h+Console' value('.cp.product'))
            };
            rewrite { 
                set("checkpoint_splunk_endpoint", value("fields.sc4s_vendor_product"));    
                set("netops", value(".splunk.index"));
                set("cp_log:endpoint", value(".splunk.source"));
            };
        } elif  {
            filter {
                match('VPN' value('.cp.product'))
                or match('Mobile' value('.cp.product'))
                or match('Mobile\h+App' value('.cp.product'))
                or match('VPN' value('.cp.fw_subproduct'))
                or match('VPN-1' value('.cp.fw_subproduct'))
            };
            rewrite { 
                set("checkpoint_splunk_sessions", value("fields.sc4s_vendor_product"));    
                set("netops", value(".splunk.index"));
                set("cp_log:sessions", value(".splunk.source"));
            };
        } elif  {
            filter {
                match('IOS\h+Profile' value('.cp.product'))
                or match('iOS\h+Profiles' value('.cp.product'))
                or match('Device' value('.cp.product'))
                or match('WIFI\h+Network' value('.cp.product'))
                or match('Mobile\h+Access' value('.cp.product'))
            };
            rewrite { 
                set("checkpoint_splunk_network", value("fields.sc4s_vendor_product"));    
                set("netops", value(".splunk.index"));
                set("cp_log:network", value(".splunk.source"));
            };
        } elif  {
            filter {
                match('Threat\h+Emulation' value('.cp.product'))
                or match('Anti-Virus' value('.cp.product'))
                or match('New\h+Anti\h+Virus' value('.cp.product'))
                or match('Anti-Bot' value('.cp.product'))
                or match('Threat\h+Extraction' value('.cp.product'))
                or match('Anti-Ransomware' value('.cp.product'))
                or match('Anti-Exploit' value('.cp.product'))
                or match('Forensics' value('.cp.product'))
                or match('OS\h+Exploit' value('.cp.product'))
                or match('OS\h+Exploits' value('.cp.product'))
                or (match('Application' value('.cp.product')) and not match('Application Control' value('.cp.product')))
                or match('Text\h+Message' value('.cp.product'))
                or match('Network\h+Access' value('.cp.product'))
                or match('Zero\h+Phishing' value('.cp.product'))
                or match('Anti-Malware' value('.cp.product'))
                or match('Anti\h+Malware' value('.cp.product'))
                or match('Anti\h+Malware\h+New\h+Anti\h+Virus' value('.cp.product'))
                or match('New\h+Anti\h+Virus\h+Anti\h+Malware' value('.cp.product'))
            };
            rewrite { 
                set("checkpoint_splunk_ids_malware", value("fields.sc4s_vendor_product"));    
                set("netids", value(".splunk.index"));
                set("cp_log:ids_malware", value(".splunk.source"));
            };
        } elif  {
            filter {
                match('IPS' value('.cp.product'))
                or match('W[iI][fF][iI]' value('.cp.product'))
                or match('Cellular' value('.cp.product'))
            };
            rewrite { 
                set("checkpoint_splunk_ids", value("fields.sc4s_vendor_product"));    
                set("netids", value(".splunk.index"));
                set("cp_log:ids", value(".splunk.source"));
            };
        } elif  {
            filter {
                match('MTA' value('.cp.product'))
                or match('Anti-Spam' value('.cp.product'))
                or match('Anti\h+Spam' value('.cp.product'))
            };
            rewrite { 
                set("checkpoint_splunk_email", value("fields.sc4s_vendor_product"));    
                set("email", value(".splunk.index"));
                set("cp_log:email", value(".splunk.source"));
            };
        } elif  {            
            filter {
                match('DLP' value('.cp.product'))
            };
            rewrite { 
                set("checkpoint_splunk_dlp", value("fields.sc4s_vendor_product"));    
                set("netfw", value(".splunk.index"));
                set("cp_log:firewall", value(".splunk.source"));
            };
        } elif {
            filter {
                match('Syslog' value('.cp.product'))
            };
            rewrite { 
                set("checkpoint_splunk_os", value("fields.sc4s_vendor_product"));    
                set("netops", value(".splunk.index"));
            };
        } else {
            rewrite { 
                set("checkpoint_splunk", value("fields.sc4s_vendor_product"));    
                set("netops", value(".splunk.index"));
                set("cp_log:cp_default", value(".splunk.source"));
            };
        };

        parser {p_add_context_splunk(key("${fields.sc4s_vendor_product}")); };
        parser (compliance_meta_by_source);
        rewrite { set("$(template ${.splunk.sc4s_template} $(template t_JSON_5424))" value("MSG")); };

   };
};
application checkpoint_splunk[raw-syslog] {
	filter { 
        message('^.{0,64}?time=\d{10}\|hostname=');
    };	

    parser { checkpoint_splunk-parser(); };   
};

filter f_soup_is_checkpoint_splunk {
    "checkpoint_splunk" eq "${fields.sc4s_syslog_format}"
};